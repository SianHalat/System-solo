<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYSTEM V42 - Fluid Timer</title>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=Noto+Sans+SC&family=Noto+Sans+JP&display=swap" rel="stylesheet">
    <style>
        :root { 
            --blue: #00eaff; 
            --glow: 0 0 10px #00eaff; 
            --bg: #02050a; 
            --red: #ff3333; 
            --gray: #444;
            --sys-text-glow: 0 0 8px var(--blue);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; outline: none;}
        
        body { 
            background-color: #02050a;
            background-image: 
                radial-gradient(circle at 50% 50%, transparent 20%, #02050a 120%),
                linear-gradient(rgba(0, 234, 255, 0.08) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 234, 255, 0.08) 1px, transparent 1px);
            background-size: 100% 100%, 30px 30px, 30px 30px;
            background-attachment: fixed;
            color: #fff; 
            font-family: 'Chakra Petch', sans-serif; 
            min-height: 100vh; 
            padding: 15px; 
            padding-bottom: 90px; 
            display: flex;             
            flex-direction: column;
            align-items: center;
        }

        .layout-wrapper { width: 100%; max-width: 500px; position: relative; }

        .main-frame { 
            width: 100%; border: 2px solid #fff; padding: 25px; 
            background: rgba(2, 8, 20, 0.9); position: relative; box-shadow: var(--glow); 
            padding-top: 20px; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); z-index: 10;
            min-height: 600px; /* Altura mínima para acomodar o timer lá embaixo */
            display: flex; flex-direction: column; /* Para organizar o conteúdo */
        }
        .main-frame::before { content: ''; position: absolute; top: -2px; left: -2px; width: 15px; height: 15px; border-top: 4px solid #fff; border-left: 4px solid #fff; }
        .main-frame::after { content: ''; position: absolute; bottom: -2px; right: -2px; width: 15px; height: 15px; border-bottom: 4px solid #fff; border-right: 4px solid #fff; }

        /* --- INTERFACE DIREITA (Status/Pontos) --- */
        .top-right-stack { 
            position: absolute; top: 30px; right: 25px; 
            display: flex; flex-direction: column; align-items: flex-end; gap: 10px; z-index: 50; 
        }

        .kebab-btn { width: 20px; height: 20px; position: relative; background: none; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .kebab-btn::before { content: ''; width: 4px; height: 4px; border-radius: 50%; background: #fff; box-shadow: 0 -7px 0 #fff, 0 7px 0 #fff; filter: drop-shadow(0 0 3px var(--blue)); }

        .res-row { font-size: 0.8rem; color: #8899aa; display: flex; gap: 10px; align-items: center; justify-content: flex-end; height: 24px; }
        .sys-num-unified { color: #fff; font-family: 'Chakra Petch', sans-serif; font-weight: 700; font-size: 1.2rem; text-shadow: var(--sys-text-glow); letter-spacing: 1px; }

        /* --- CAIXA DE GOLD --- */
        #gold-container-wrapper { width: 100%; display: none; justify-content: flex-end; margin-top: 8px; }
        .gold-box-frame {
            border: 2px solid #fff; background: rgba(2, 8, 20, 0.9); backdrop-filter: blur(4px); box-shadow: var(--glow); padding: 5px 20px; display: flex; align-items: center; gap: 15px; position: relative;
        }
        .gold-box-frame::before { content: ''; position: absolute; top: -2px; left: -2px; width: 6px; height: 6px; border-top: 2px solid #fff; border-left: 2px solid #fff; }
        .gold-box-frame::after { content: ''; position: absolute; bottom: -2px; right: -2px; width: 6px; height: 6px; border-bottom: 2px solid #fff; border-right: 2px solid #fff; }

        .gold-wrapper { display: inline-flex; align-items: center; }
        .gold-icon { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; border: 1.5px solid #fff; border-radius: 50%; box-shadow: 0 0 8px var(--blue), inset 0 0 2px var(--blue); color: #fff; font-size: 0.7rem; font-weight: 800; text-shadow: 0 0 5px var(--blue); margin-left: 5px; position: relative; top: -1px; }

        @keyframes system-fade { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes sys-open { 0% { transform: scaleY(0); opacity: 0; } 100% { transform: scaleY(1); opacity: 1; } }
        
        /* ANIMAÇÃO DO TIMER FLUIDA */
        @keyframes timer-slide-up {
            0% { opacity: 0; transform: translateY(30px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .content { display: none; width: 100%; }
        .content.active { display: block; animation: system-fade 0.4s ease; }

        h2.tab-title { text-align: center; letter-spacing: 5px; text-shadow: 0 0 10px var(--blue); margin-bottom: 30px; font-size: 1.8rem; margin-top: 10px; }
        .header-grid { display: grid; grid-template-columns: auto 1fr; gap: 25px; align-items: end; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 20px; margin-bottom: 20px; }
        .lvl-num { font-size: 4.5rem; font-weight: 700; text-shadow: 0 0 15px #fff; line-height: 0.8; }
        .info-box { display: flex; flex-direction: column; gap: 6px; }
        .info-row { font-size: 0.85rem; color: #888; display: flex; align-items: center; margin-bottom: 4px; }
        .info-val { color: #fff; font-weight: bold; text-transform: uppercase; text-shadow: var(--sys-text-glow); }
        .rank-box { color: #fff; border: 1px solid var(--blue); padding: 0 5px; margin-left: 5px; font-weight: bold; text-shadow: var(--sys-text-glow); box-shadow: 0 0 5px rgba(0, 234, 255, 0.3); }
        
        .bar-container { width: 100%; height: 4px; background: rgba(255,255,255,0.1); margin-top: 10px; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.5s ease; }
        .xp-fill { background: #fff; box-shadow: 0 0 10px #fff; }
        .fatigue-fill { background: #ff3333; box-shadow: 0 0 10px #ff3333; }
        .stat-row { display: flex; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px; margin-bottom: 8px; }
        .stat-label { font-size: 1.2rem; font-weight: 600; color: #ccc; width: 50px; }
        .stat-val { font-size: 1.6rem; font-weight: 700; margin-left: 10px; color: #fff; text-shadow: var(--sys-text-glow); }
        .plus-btn { width: 24px; height: 24px; border: 1px solid var(--blue); margin-left: auto; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--blue); }

        .quest-item, .dungeon-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #333; align-items: center; }
        .quest-reward { color: #888; font-size: 0.7rem; margin-left: 10px; }
        
        .mon-white { color: #fff; text-shadow: 0 0 5px #fff; }
        .mon-orange { color: #FFA500; text-shadow: 0 0 5px #FFA500; } 
        .mon-red { color: var(--red); text-shadow: 0 0 5px var(--red); }
        
        .enter-btn { border: 1px solid var(--red); color: var(--red); background: rgba(255, 50, 50, 0.1); padding: 5px 15px; font-weight: bold; cursor: pointer; min-width: 80px; }
        .enter-btn.cooldown { border: 1px solid var(--gray); color: var(--gray); background: rgba(0,0,0,0.5); cursor: not-allowed; font-size: 0.7rem; }
        
        .claim-btn { width:100%; padding:15px; margin-top:20px; border:1px solid var(--blue); color:var(--blue); background:rgba(0,234,255,0.1); font-weight:bold; cursor:pointer; }
        .claim-btn.disabled { border:1px solid var(--gray); color:var(--gray); background:transparent; cursor:not-allowed; }

        #sys-modal { position: absolute; top: 150px; left: 5%; width: 90%; background: rgba(2, 8, 20, 0.98); border: 2px solid var(--blue); box-shadow: 0 0 30px var(--blue); z-index: 2000; display: none; flex-direction: column; padding: 20px; text-align: center; animation: sys-open 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .shop-item { border: 1px solid var(--blue); padding: 12px; text-align: center; background: rgba(0,0,0,0.6); cursor: pointer; }
        .item-card { border: 1px solid var(--blue); background: rgba(0,234,255,0.05); padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .item-btn-group { display: flex; gap: 5px; }
        .use-btn { border: 1px solid var(--blue); color: var(--blue); background:none; padding: 2px 8px; font-size: 0.7rem; cursor: pointer; }
        .sell-btn { border: 1px solid var(--blue); color: var(--blue); background:none; padding: 2px 8px; font-size: 0.7rem; cursor: pointer; text-shadow: 0 0 5px var(--blue); }
        
        /* --- NOVO TIMER DE MISSÃO FLUIDO --- */
        /* Container que aparece na parte inferior do dungeon/quest tab */
        .active-mission-box {
            margin-top: 30px;
            margin-bottom: 10px;
            padding: 15px;
            border: 2px solid var(--blue);
            background: rgba(0, 234, 255, 0.05);
            text-align: center;
            display: none; /* Controlado por JS */
            box-shadow: inset 0 0 15px rgba(0, 234, 255, 0.1);
            
            /* Animação Fluida */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .active-mission-box.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .timer-digits {
            font-size: 2.5rem;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 0 15px var(--blue);
            font-family: 'Chakra Petch', sans-serif;
            letter-spacing: 3px;
        }

        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #02050a; border-top: 2px solid #fff; display: flex; justify-content: space-around; padding: 15px 0; z-index: 100; }
        .nav-btn { background: none; border: none; color: #444; font-family: inherit; font-size: 0.8rem; font-weight: bold; letter-spacing: 1px; }
        .nav-btn.active { color: #fff; text-shadow: var(--glow); transform: scale(1.1); }
        #notification { position: fixed; top: 20px; width: 80%; left: 10%; background: var(--blue); color: #000; padding: 10px; text-align: center; font-weight: bold; z-index: 3000; display: none; box-shadow: 0 0 20px var(--blue); animation: system-fade 0.2s; }
    </style>
</head>
<body id="b">
    <div id="notification">MSG</div>

    <div id="m" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:1000; display:none; justify-content:center; align-items:center;">
        <div style="background:#050a15; border:2px solid var(--blue); padding:30px; width:85%; max-width:400px; text-align:center;">
            <h2 style="margin-bottom:20px; color:var(--blue);">SETTINGS</h2>
            <select id="lang" onchange="game.setLang(this.value)" style="width:100%; padding:12px; background:#000; color:#fff; border:1px solid var(--blue); margin-bottom: 25px; font-family:inherit;">
                <option value="en">English</option>
                <option value="pt">Português</option>
            </select>
            <button onclick="game.reset()" style="width:100%; padding:12px; border:1px solid red; color:red; background:transparent; margin-bottom:10px; font-weight:bold; cursor:pointer;">RESET SYSTEM</button>
            <button onclick="ui.toggleSettings()" style="width:100%; padding:12px; background:var(--blue); color:#000; border:none; font-weight:bold; cursor:pointer;">CLOSE</button>
        </div>
    </div>

    <div class="layout-wrapper">
        <div class="main-frame">
            
            <div id="sys-modal">
                <h3 style="color:#fff; margin-bottom:10px;">YOU DEFEATED THE ENEMY</h3>
                <div id="sys-msg-detail" style="color:#aaa; font-size:0.9rem; margin-bottom:15px;"></div>
                <div style="font-size:1.2rem; color:var(--blue); margin-bottom:15px; border:1px solid var(--blue); padding:10px; width:100%;">
                    ITEM ACQUIRED<br>
                    <span id="sys-item-name" style="color:#fff; font-weight:bold;">NONE</span>
                </div>
                <button onclick="document.getElementById('sys-modal').style.display='none'" style="background:var(--blue); border:none; padding:8px 20px; font-weight:bold; cursor:pointer;">CONFIRM</button>
            </div>
            
            <div class="top-right-stack">
                <div id="ui-kebab"><button class="kebab-btn" onclick="ui.toggleSettings()"></button></div>
                <div id="ui-pts" class="res-row">
                    <span id="txt-pts-lbl">POINTS:</span> <span id="val-pts" class="sys-num-unified">0</span>
                </div>
            </div>

            <div id="tab-status" class="content active">
                <h2 id="txt-status" class="tab-title">STATUS</h2>
                <div class="header-grid">
                    <div><div id="val-lvl" class="lvl-num">1</div><div style="font-size:0.7rem; color:var(--blue); text-align:center;">LEVEL</div></div>
                    <div class="info-box">
                        <div class="info-row">RANK: <span id="val-rank" class="rank-box">E</span></div>
                        <div class="info-row">JOB: <span id="val-job" class="info-val" style="margin-left:5px;">NONE</span></div>
                        <div class="info-row">TITLE: <span id="val-title" class="info-val" style="margin-left:5px;">NONE</span></div>
                        <div style="font-size:0.6rem; margin-top:10px;">XP</div>
                        <div class="bar-container"><div id="xp-bar" class="bar-fill xp-fill"></div></div>
                        <div style="font-size:0.6rem; margin-top:5px;">FATIGUE: <span id="val-fatigue-num">0</span>%</div>
                        <div class="bar-container"><div id="fatigue-bar" class="bar-fill fatigue-fill"></div></div>
                    </div>
                </div>
                <div class="stats-list">
                    <div class="stat-row"><span class="stat-label">STR</span><span id="val-STR" class="stat-val">10</span><div class="plus-btn" onclick="game.add('STR')">+</div></div>
                    <div class="stat-row"><span class="stat-label">VIT</span><span id="val-VIT" class="stat-val">10</span><div class="plus-btn" onclick="game.add('VIT')">+</div></div>
                    <div class="stat-row"><span class="stat-label">AGI</span><span id="val-AGI" class="stat-val">10</span><div class="plus-btn" onclick="game.add('AGI')">+</div></div>
                    <div class="stat-row"><span class="stat-label">INT</span><span id="val-INT" class="stat-val">10</span><div class="plus-btn" onclick="game.add('INT')">+</div></div>
                    <div class="stat-row"><span class="stat-label">PER</span><span id="val-PER" class="stat-val">10</span><div class="plus-btn" onclick="game.add('PER')">+</div></div>
                </div>
            </div>

            <div id="tab-quests" class="content">
                <h2 id="txt-quests" class="tab-title">DAILY QUESTS</h2>
                <div id="q-list"></div>
                <button id="btn-claim" class="claim-btn" onclick="game.claimDailyRewards()">CLAIM XP</button>
            </div>

            <div id="tab-dungeon" class="content">
                <h2 class="tab-title">DUNGEONS</h2>
                <div id="dungeon-list"></div>

                <div id="active-mission-box" class="active-mission-box">
                    <div id="mission-timer-text" class="timer-digits">00:00:00</div>
                </div>
            </div>

            <div id="tab-shop" class="content">
                <h2 id="txt-shop" class="tab-title">SHOP</h2>
                <div class="shop-grid">
                    <div class="shop-item" onclick="game.buy('Bandage', 30)">BANDAGE<br><span class="gold-wrapper"><span class="sys-num-unified">30</span><span class="gold-icon">G</span></span><br><small>-10 Fatigue</small></div>
                    <div class="shop-item" onclick="game.buy('Potion', 100)">POTION<br><span class="gold-wrapper"><span class="sys-num-unified">100</span><span class="gold-icon">G</span></span><br><small>-40 Fatigue</small></div>
                    <div class="shop-item" onclick="game.buy('Return Stone', 200)">RETURN STONE<br><span class="gold-wrapper"><span class="sys-num-unified">200</span><span class="gold-icon">G</span></span></div>
                    <div class="shop-item" onclick="game.buy('E-Rank Dagger', 500)">DAGGER<br><span class="gold-wrapper"><span class="sys-num-unified">500</span><span class="gold-icon">G</span></span></div>
                </div>
                <h3 style="margin-top:25px; border-bottom:1px solid #333;" id="txt-inv">INVENTORY</h3>
                <div id="inv-list" style="padding-top:10px;"></div>
            </div>

        </div>

        <div id="gold-container-wrapper">
            <div class="gold-box-frame">
                <span id="txt-gold-lbl" style="font-size:0.8rem; color:#8899aa;">GOLD:</span> 
                <span class="gold-wrapper">
                    <span id="val-gold" class="sys-num-unified">0</span><span class="gold-icon">G</span>
                </span>
            </div>
        </div>

    </div>

    <nav class="nav-bar">
        <button class="nav-btn active" id="n-status" onclick="ui.tab('status')">STATUS</button>
        <button class="nav-btn" id="n-quests" onclick="ui.tab('quests')">QUESTS</button>
        <button class="nav-btn" id="n-dungeon" onclick="ui.tab('dungeon')">DUNGEON</button>
        <button class="nav-btn" id="n-shop" onclick="ui.tab('shop')">SHOP</button>
    </nav>

    <script>
        const trans = {
            en: { status: "STATUS", quests: "DAILY QUESTS", shop: "SHOP", pts: "POINTS:", gold: "GOLD:", settings: "SETTINGS", inv: "INVENTORY", empty: "Empty", use: "USE", sell: "SELL", claim: "[ CLAIM XP ]", q1: "Push-ups", q2: "Sit-ups", q3: "Squats", q4: "10km Run", j0: "NONE", j2: "SHADOW MONARCH", j3: "SOUL SHEPHERD", j4: "TITAN OF TWILIGHT", t0: "NONE", t1: "WOLF ASSASSIN", t2: "ONE WHO OVERCAME ADVERSITY", t3: "DEMON SLAYER" },
            pt: { status: "STATUS", quests: "MISSÕES", shop: "LOJA", pts: "PONTOS:", gold: "OURO:", settings: "CONFIGURAÇÕES", inv: "INVENTÁRIO", empty: "Vazio", use: "USAR", sell: "VENDER", claim: "[ RESGATAR XP ]", q1: "Flexões", q2: "Abdominais", q3: "Agachamentos", q4: "Correr 10km", j0: "NENHUM", j2: "MONARCA DAS SOMBRAS", j3: "PASTOR DE ALMAS", j4: "TITÃ DO CREPÚSCULO", t0: "NENHUM", t1: "ASSASSINO DE LOBOS", t2: "SUPEROU A ADVERSIDADE", t3: "ASSASSINO DE DEMÔNIOS" }
        };

        const MIN = 60000;
        const HOUR = 3600000;
        
        const dungeonData = [
            { name: "E-Rank Gate", mob: "Goblin", diff: "white", drop: "Goblin Stone", price: 10, xp: 5, cost: 5, visualTime: 3, cooldownTime: 5 * MIN }, 
            { name: "D-Rank Gate", mob: "Steel Fang Lycan", diff: "white", drop: "Lycan Fang", price: 25, xp: 15, cost: 10, visualTime: 5, cooldownTime: 15 * MIN }, 
            { name: "C-Rank Gate", mob: "Giant Centipede", diff: "orange", drop: "Centipede Shell", price: 50, xp: 40, cost: 20, visualTime: 8, cooldownTime: 30 * MIN }, 
            { name: "B-Rank Gate", mob: "Ice Bear", diff: "orange", drop: "Ice Crystal", price: 100, xp: 80, cost: 30, visualTime: 10, cooldownTime: 1 * HOUR }, 
            { name: "A-Rank Gate", mob: "High Orc", diff: "red", drop: "Orc Tusk", price: 250, xp: 150, cost: 50, visualTime: 15, cooldownTime: 4 * HOUR }, 
            { name: "S-Rank Gate", mob: "Giant Ant", diff: "red", drop: "Ant Wing", price: 1000, xp: 500, cost: 90, visualTime: 20, cooldownTime: 12 * HOUR } 
        ];

        const itemPrices = { "Goblin Stone": 10, "Lycan Fang": 25, "Centipede Shell": 50, "Ice Crystal": 100, "Orc Tusk": 250, "Ant Wing": 1000, "Bandage": 15, "Potion": 50, "Return Stone": 100, "E-Rank Dagger": 250 };

        let missionTimer = null; 

        function msToTime(duration) {
            let seconds = Math.floor((duration / 1000) % 60);
            let minutes = Math.floor((duration / (1000 * 60)) % 60);
            let hours = Math.floor((duration / (1000 * 60 * 60)) % 24);
            return (hours < 10 ? "0" + hours : hours) + ":" + (minutes < 10 ? "0" + minutes : minutes) + ":" + (seconds < 10 ? "0" + seconds : seconds);
        }

        const game = {
            data: { 
                stats: { STR: 10, VIT: 10, AGI: 10, INT: 10, PER: 10 }, 
                pts: 3, lvl: 1, gold: 0, xp: 0, fatigue: 0, lang: 'en', 
                inventory: [], 
                quests: [{id:'q1', done:false}, {id:'q2', done:false}, {id:'q3', done:false}, {id:'q4', done:false}],
                dungeonCooldowns: [],
                dailyReset: null 
            },
            init() {
                const s = localStorage.getItem('solo_v42');
                if(s) {
                    const parsed = JSON.parse(s);
                    this.data = {...this.data, ...parsed};
                    if(!this.data.dungeonCooldowns) this.data.dungeonCooldowns = [];
                }
                ui.tab('status'); 
                ui.render();
                setInterval(() => this.tick(), 1000);
            },
            save() { localStorage.setItem('solo_v42', JSON.stringify(this.data)); },
            setLang(l) { this.data.lang = l; this.save(); ui.render(); },
            reset() { if(confirm("RESET SYSTEM?")) { localStorage.removeItem('solo_v42'); location.reload(); } },
            add(k) { if(this.data.pts > 0) { this.data.stats[k]++; this.data.pts--; this.save(); ui.render(); } },
            
            tick() {
                const now = Date.now();
                if (this.data.dailyReset && now >= this.data.dailyReset) {
                    this.data.dailyReset = null;
                    this.data.quests.forEach(q => q.done = false);
                    ui.notify("DAILY QUESTS RESET");
                    this.save();
                    ui.render();
                }
                if(document.getElementById('tab-dungeon').classList.contains('active')) {
                    ui.updateDungeonButtons();
                }
                if(document.getElementById('tab-quests').classList.contains('active')) {
                    ui.updateClaimButton();
                }
            },

            // --- DAILY QUESTS ---
            toggle(i) { 
                if (this.data.dailyReset) return; 

                const q = this.data.quests[i];
                if(q.done) {
                    q.done = false;
                    this.save();
                    ui.render();
                } else {
                    // Sem timer para Daily Quest individual, apenas marcar
                    q.done = true;
                    this.save();
                    ui.render();
                }
            },

            claimDailyRewards() {
                if (this.data.dailyReset) return; 

                if(this.data.quests.every(q => q.done)) {
                    this.data.xp += 100; 
                    this.data.fatigue -= 20; if(this.data.fatigue < 0) this.data.fatigue = 0;
                    if(this.data.xp >= 100) { this.data.xp = 0; this.data.lvl++; this.data.pts += 3; ui.notify("LEVEL UP!"); }
                    
                    this.data.dailyReset = Date.now() + (24 * HOUR);
                    
                    this.save(); 
                    ui.render(); 
                    ui.notify("REWARDS CLAIMED. RESET IN 24H.");
                } else {
                    ui.notify("COMPLETE ALL QUESTS FIRST");
                }
            },
            
            // --- DUNGEON ---
            enterDungeon(idx) {
                const now = Date.now();
                const unlockTime = this.data.dungeonCooldowns[idx] || 0;
                
                if (now < unlockTime) { ui.notify("DUNGEON LOCKED"); return; }

                const dg = dungeonData[idx];
                if(this.data.fatigue + dg.cost > 100) { ui.notify("FATIGUE TOO HIGH!"); return; }
                
                this.data.fatigue += dg.cost;
                this.save();
                ui.render();
                
                // Inicia Timer Fluido na parte inferior
                ui.startMissionTimer(dg.visualTime, () => {
                    this.data.dungeonCooldowns[idx] = Date.now() + dg.cooldownTime;

                    const successChance = 0.8;
                    ui.stopMissionTimer(); 
                    
                    if(Math.random() < successChance) {
                        this.data.xp += dg.xp; this.data.inventory.push(dg.drop);
                        if(this.data.xp >= 100) { this.data.xp = 0; this.data.lvl++; this.data.pts += 3; }
                        ui.showSysModal(dg.mob, dg.drop);
                    } else { 
                        ui.notify("DEFEAT! ESCAPED SAFELY..."); 
                    }
                    this.save(); ui.render();
                });
            },

            buy(n, c) { if(this.data.gold >= c) { this.data.gold -= c; this.data.inventory.push(n); this.save(); ui.render(); ui.notify("BOUGHT: " + n); } else { ui.notify("NOT ENOUGH GOLD"); } },
            useItem(index) {
                const item = this.data.inventory[index];
                if(item === 'Bandage') { this.data.fatigue -= 10; }
                else if(item === 'Potion') { this.data.fatigue -= 40; }
                else { ui.notify("CANNOT USE."); return; }
                if(this.data.fatigue < 0) this.data.fatigue = 0;
                this.data.inventory.splice(index, 1); this.save(); ui.render();
            },
            sellItem(index) {
                const item = this.data.inventory[index];
                const price = itemPrices[item] || 0;
                this.data.gold += price;
                this.data.inventory.splice(index, 1);
                this.save(); ui.render(); ui.notify(`SOLD: +${price}G`);
            },
            getRank(l) { if(l<=3) return 'E'; if(l<=8) return 'D'; if(l<=19) return 'C'; if(l<=39) return 'B'; if(l<=59) return 'A'; if(l<=69) return 'S'; if(l<=89) return 'SS'; return 'SSS'; },
            getJobKey(l) { if(l < 40) return 'j0'; if(l < 80) return 'j2'; if(l < 100) return 'j3'; return 'j4'; },
            getTitleKey(l) { if(l < 15) return 't0'; if(l < 40) return 't1'; if(l < 60) return 't2'; return 't3'; }
        };

        const ui = {
            tab(n) {
                const els = { kebab: document.getElementById('ui-kebab'), pts: document.getElementById('ui-pts'), goldBox: document.getElementById('gold-container-wrapper') };
                const showResources = (n === 'status' || n === 'shop');
                els.goldBox.style.display = showResources ? 'flex' : 'none';
                els.kebab.style.display = (n === 'status') ? 'flex' : 'none';
                els.pts.style.display = (n === 'status') ? 'flex' : 'none';

                document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('tab-' + n).classList.add('active');
                document.getElementById('n-' + n).classList.add('active');
            },

            startMissionTimer(durationSeconds, onComplete) {
                const timerContainer = document.getElementById('active-mission-box');
                const timerText = document.getElementById('mission-timer-text');
                
                timerContainer.style.display = 'block';
                // Trigger reflow para a animação funcionar
                void timerContainer.offsetWidth; 
                timerContainer.classList.add('visible');
                
                let remaining = durationSeconds;
                
                const updateText = () => {
                   let m = Math.floor(remaining / 60);
                   let s = Math.floor(remaining % 60);
                   let ms = Math.floor((remaining % 1) * 100);
                   timerText.innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}:${ms < 10 ? '0'+ms : ms}`;
                };
                
                updateText();

                if (missionTimer) clearInterval(missionTimer);
                missionTimer = setInterval(() => {
                    remaining -= 0.1; 
                    if (remaining <= 0) {
                        clearInterval(missionTimer);
                        timerText.innerText = `00:00:00`;
                        // Delay para fechar
                        setTimeout(() => { 
                             onComplete();
                        }, 500);
                        return;
                    }
                    updateText();
                }, 100); 
            },

            stopMissionTimer() {
                if (missionTimer) clearInterval(missionTimer);
                const timerContainer = document.getElementById('active-mission-box');
                timerContainer.classList.remove('visible');
                setTimeout(() => {
                    timerContainer.style.display = 'none';
                }, 400); // Espera a animação de saída
            },

            updateDungeonButtons() {
                const now = Date.now();
                const btns = document.querySelectorAll('.enter-btn');
                btns.forEach((btn, i) => {
                    const unlockTime = game.data.dungeonCooldowns[i] || 0;
                    if (now < unlockTime) {
                        const diff = unlockTime - now;
                        btn.innerText = msToTime(diff);
                        btn.classList.add('cooldown');
                        btn.disabled = true;
                    } else {
                        btn.innerText = "ENTER";
                        btn.classList.remove('cooldown');
                        btn.disabled = false;
                    }
                });
            },

            updateClaimButton() {
                const btn = document.getElementById('btn-claim');
                if (game.data.dailyReset) {
                    const now = Date.now();
                    const diff = game.data.dailyReset - now;
                    if (diff > 0) {
                        btn.innerText = `NEXT RESET: ${msToTime(diff)}`;
                        btn.classList.add('disabled');
                        return;
                    }
                }
                btn.innerText = "[ CLAIM XP ]";
                btn.classList.remove('disabled');
            },

            toggleSettings() { document.getElementById('m').style.display = (document.getElementById('m').style.display === 'flex') ? 'none' : 'flex'; },
            notify(m) { const n = document.getElementById('notification'); n.innerText = m; n.style.display = 'block'; setTimeout(() => n.style.display = 'none', 2000); },
            showSysModal(mob, item) {
                document.getElementById('sys-msg-detail').innerText = `You have slain the ${mob}.`;
                document.getElementById('sys-item-name').innerText = item;
                document.getElementById('sys-modal').style.display = 'flex';
            },
            render() {
                const d = game.data; const t = trans[d.lang];
                document.getElementById('txt-status').innerText = t.status;
                document.getElementById('txt-quests').innerText = t.quests;
                document.getElementById('txt-shop').innerText = t.shop;
                document.getElementById('txt-inv').innerText = t.inv;
                document.getElementById('n-status').innerText = t.status;
                document.getElementById('n-quests').innerText = t.quests;
                document.getElementById('n-dungeon').innerText = "DUNGEON";
                document.getElementById('n-shop').innerText = t.shop;
                document.getElementById('val-lvl').innerText = d.lvl;
                document.getElementById('val-pts').innerText = d.pts;
                document.getElementById('val-gold').innerText = d.gold;
                document.getElementById('val-fatigue-num').innerText = d.fatigue;
                document.getElementById('xp-bar').style.width = d.xp + "%";
                document.getElementById('fatigue-bar').style.width = d.fatigue + "%";
                document.getElementById('val-rank').innerText = game.getRank(d.lvl);
                document.getElementById('val-job').innerText = t[game.getJobKey(d.lvl)];
                document.getElementById('val-title').innerText = t[game.getTitleKey(d.lvl)];
                for(let k in d.stats) document.getElementById('val-'+k).innerText = d.stats[k];
                
                const qL = document.getElementById('q-list'); qL.innerHTML = '';
                const isDailyLocked = !!d.dailyReset;
                d.quests.forEach((q, i) => {
                    const checked = q.done ? 'checked' : '';
                    const disabled = isDailyLocked ? 'disabled' : ''; 
                    qL.innerHTML += `<div class="quest-item"><div><span style="${q.done?'text-decoration:line-through;color:#444':''}">${t[q.id]}</span></div><input type="checkbox" onclick="game.toggle(${i}); return false;" ${checked} ${disabled}></div>`;
                });
                this.updateClaimButton();

                const dL = document.getElementById('dungeon-list'); dL.innerHTML = '';
                dungeonData.forEach((dg, i) => {
                    dL.innerHTML += `<div class="dungeon-item"><div><div style="font-weight:bold;">${dg.name}</div><div class="mon-${dg.diff}" style="font-size:0.8rem;">${dg.mob}</div></div><button class="enter-btn" onclick="game.enterDungeon(${i})">ENTER</button></div>`;
                });
                this.updateDungeonButtons();

                const iL = document.getElementById('inv-list');
                if(d.inventory.length === 0) iL.innerHTML = `<div style="color:#444;text-align:center;">${t.empty}</div>`;
                else iL.innerHTML = d.inventory.map((item, index) => `
                    <div class="item-card"><span>${item}</span><div style="display:flex;gap:5px;"><button onclick="game.useItem(${index})" style="border:1px solid var(--blue);color:var(--blue);background:none;padding:2px 5px;font-size:0.7rem;">${t.use}</button><button onclick="game.sellItem(${index})" style="border:1px solid var(--blue);color:var(--blue);background:none;padding:2px 5px;font-size:0.7rem;text-shadow:0 0 5px var(--blue);">${t.sell}</button></div></div>`).join('');
            }
        };
        game.init();
    </script>
</body>
</html>